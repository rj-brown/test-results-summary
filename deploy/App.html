<!DOCTYPE html>
<html>
<head>
    <title>TestCaseApp</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"exportBtn",cls:"export-button"},{xtype:"container",itemId:"releaseCombobox",cls:"release-combo-box"},{xtype:"container",itemId:"gridContainer"}],launch:function(){this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Loading data..."}),this._myMask.show(),this.down("#releaseCombobox").add({xtype:"rallyreleasecombobox",itemId:"stateComboBox",allowNoEntry:!0,noEntryText:"All Releases",value:"All Releases",model:"TestCase",listeners:{scope:this,select:this._onSelect,ready:this._initStore}})},_getReleaseFilter:function(){return{property:"WorkProductRelease",operator:"=",value:Number(this.down("#stateComboBox").getRawValue().split(" (")[0].replace(/\D+/g,""))}},_onSelect:function(){var store=this._grid.getStore();store.clearFilter(!0),"All Releases"!==this.down("#stateComboBox").getRawValue()?store.filter(this._getReleaseFilter()):store.reload()},_initStore:function(){this._userStoryStore=Ext.create("Rally.data.wsapi.Store",{model:"UserStory",autoLoad:!0,remoteSort:!1,fetch:["FormattedID","Name","ScheduleState","Release","Feature"],limit:1/0}),this._userStoryStore.on("load",function(){this._defectsStore=Ext.create("Rally.data.wsapi.Store",{model:"Defect",autoLoad:!0,remoteSort:!1,fetch:["FormattedID","State","TestCase","Release"],limit:1/0}),this._defectsStore.on("load",function(){Ext.create("Rally.data.wsapi.Store",{model:"TestCase",autoLoad:!0,remoteSort:!1,fetch:["FormattedID","Name","Type","LastRun","LastVerdict","LastBuild","WorkProduct","c_Iteration","Defects"],limit:1/0,listeners:{load:this._onDataLoaded,scope:this}})},this)},this)},_onDataLoaded:function(store,data){_.each(data,function(testcase){if(testcase.data.WorkProduct&&(testcase.set("WorkProductNumericID",Number(testcase.data.WorkProduct.FormattedID.replace(/\D+/g,""))),testcase.data.WorkProduct.FormattedID.indexOf("US")>-1&&_.each(this._userStoryStore.data.items,function(userStory){userStory.data.FormattedID===testcase.data.WorkProduct.FormattedID&&(userStory.data.ScheduleState&&testcase.set("WorkProductScheduleState",userStory.get("ScheduleState")),userStory.data.Release&&testcase.set("WorkProductRelease",Number(userStory.get("Release").Name.replace(/\D+/g,""))),userStory.data.Feature&&(testcase.data.WorkProductFeatureID=[{_ref:userStory.get("Feature")._ref,FormattedID:userStory.get("Feature").FormattedID}],testcase.set("WorkProductFeatureName",userStory.get("Feature").Name)))},this),testcase.data.WorkProduct.FormattedID.indexOf("DE")>-1&&_.each(this._defectsStore.data.items,function(defect){defect.data.FormattedID===testcase.data.WorkProduct.FormattedID&&(defect.data.State&&testcase.set("WorkProductScheduleState",defect.get("State")),defect.data.Release&&defect.get("Release").Name&&testcase.set("WorkProductRelease",Number(defect.get("Release").Name.replace(/\D+/g,""))))},this)),testcase.data.Defects&&testcase.data.Defects.Count>0){var defectHtml=[];_.each(this._defectsStore.data.items,function(defect){defect.data.TestCase&&defect.data.TestCase.FormattedID===testcase.data.FormattedID&&defectHtml.push('<a href="'+Rally.nav.Manager.getDetailUrl(defect)+'" target="_blank">'+defect.data.FormattedID+"</a> - "+defect.data.State)},this),testcase.set("OpenDefects",defectHtml.join("</br>"))}},this),this._makeGrid(data)},_makeGrid:function(testcases){this._myMask.hide();var store=Ext.create("Rally.data.custom.Store",{data:testcases,proxy:{type:"memory"}});this._testcases=testcases,this._grid=Ext.create("Rally.ui.grid.Grid",{itemId:"testcasesGrid",store:store,showRowActionsColumn:!1,showPagingToolbar:!1,columnCfgs:[{text:"Test Case ID",dataIndex:"FormattedID",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Test Case Name",dataIndex:"Name",flex:1},{text:"Test Case Type",dataIndex:"Type"},{text:"Work Product ID",dataIndex:"WorkProduct",renderer:function(value){return value?'<a href="'+Rally.nav.Manager.getDetailUrl(value)+'" target="_blank">'+value.FormattedID+"</a>":void 0},getSortParam:function(){return"WorkProductNumericID"}},{text:"Work Product State",dataIndex:"WorkProductScheduleState"},{text:"Feature ID",dataIndex:"WorkProductFeatureID",renderer:function(value){return value?'<a href="'+Rally.nav.Manager.getDetailUrl(value[0])+'" target="_blank">'+value[0].FormattedID+"</a>":void 0},getSortParam:function(){return"WorkProductNumericID"}},{text:"Feature Name",dataIndex:"WorkProductFeatureName"},{text:"Test Case Last Run",dataIndex:"LastRun",xtype:"datecolumn",format:"D n/j/Y"},{text:"Test Case Last Build",dataIndex:"LastBuild"},{text:"Test Case Last Verdict",dataIndex:"LastVerdict",sortable:!1},{text:"Defects",dataIndex:"OpenDefects"}]}),this.down("#gridContainer").add(this._grid),this.down("#exportBtn").add({xtype:"rallybutton",text:"Export to CSV",href:"data:text/csv;charset=utf8,"+encodeURIComponent(this._getCSV()),id:"exportButton",scope:this}),document.getElementById("exportButton").setAttribute("download","export.csv")},_getCSV:function(){var cols=this._grid.columns,data="";return _.each(cols,function(col){data+=this._getFieldTextAndEscape(col.text)+","},this),data+="\r\n",_.each(this._testcases,function(record){_.each(cols,function(col){var fieldName=col.dataIndex;if("WorkProduct"===fieldName&&record.data.WorkProduct)data+=this._getFieldTextAndEscape(record.data.WorkProduct.FormattedID)+",";else if("WorkProductFeatureID"===fieldName&&record.data.WorkProductFeatureID)data+=this._getFieldTextAndEscape(record.data.WorkProductFeatureID[0].FormattedID)+",";else if("LastRun"===fieldName){var lastRunText="";record.data.LastRun&&(lastRunText=""+record.data.LastRun),data+=this._getFieldTextAndEscape(lastRunText)+","}else if("OpenDefects"===fieldName&&record.data.OpenDefects){var text='"';_.each(this._defectsStore.data.items,function(defect){defect.data.TestCase&&defect.data.TestCase.FormattedID===record.data.FormattedID&&(text+=defect.data.FormattedID+" - "+defect.data.State+"\n")},this),text+='"',data+=text+","}else data+=this._getFieldTextAndEscape(record.get(fieldName))+","},this),data+="\r\n"},this),data},_getFieldTextAndEscape:function(fieldData){var string=this._getFieldText(fieldData);return this._escapeForCSV(string)},_getFieldText:function(fieldData){var text;return text=null!==fieldData&&void 0!==fieldData&&fieldData.match?fieldData._refObjectName?fieldData._refObjectName:fieldData:""},_escapeForCSV:function(string){return string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string}});

            Rally.launchApp('CustomApp', {
                name:"TestCaseApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .export-button{display:inline;float:right;width:100px}.release-combo-box{display:inline;float:left;width:370px}.x-panel-body{height:auto !important}.x-panel-default{height:auto !important}
    </style>
</head>
<body>
</body>
</html>
